---
# Gluetun VPN container for secure internet access

- name: Create Gluetun stack directory
  ansible.builtin.file:
    path: "{{ media_services_stacks_dir }}/gluetun"
    state: directory
    mode: "0755"

- name: Deploy Gluetun docker-compose.yml
  ansible.builtin.copy:
    dest: "{{ media_services_stacks_dir }}/gluetun/docker-compose.yml"
    content: |
      services:
        gluetun:
          image: qmcgaw/gluetun:latest
          container_name: gluetun
          restart: unless-stopped
          cap_add:
            - NET_ADMIN
          devices:
            - /dev/net/tun:/dev/net/tun
          environment:
            # Use custom provider for fixed endpoint
            - VPN_SERVICE_PROVIDER=custom
            - VPN_TYPE=wireguard
            - WIREGUARD_PRIVATE_KEY={{ vault_protonvpn_wireguard_private_key }}
            - WIREGUARD_ADDRESSES={{ vault_protonvpn_wireguard_addresses | default('10.2.0.2/32') }}
            # Fixed endpoint ProtonVPN CH#609
            - WIREGUARD_PUBLIC_KEY=Ii6hAbnu84wZ8NzVt5+ylO4FnX+ANrKNzpFOSYq9dks=
            - WIREGUARD_ENDPOINT_IP=79.127.184.216
            - WIREGUARD_ENDPOINT_PORT=51820
            - TZ={{ media_services_timezone }}
            # Allow local network access (for Prowlarr â†’ Sonarr/Radarr communication)
            - FIREWALL_OUTBOUND_SUBNETS=192.168.178.0/24
          ports:
            # Prowlarr via Gluetun
            - "{{ media_services_prowlarr_port }}:9696"
            # SABnzbd via Gluetun
            - "{{ media_services_sabnzbd_port }}:8080"
            # qBittorrent via Gluetun
            - "{{ media_services_qbittorrent_port }}:8081"
            # Umlautadaptarr via Gluetun
            - "{{ media_services_umlautadaptarr_port }}:5006"
          volumes:
            - ./config:/gluetun
          healthcheck:
            test: ["CMD", "wget", "-qO-", "https://ipinfo.io/ip"]
            interval: 60s
            timeout: 10s
            retries: 3
            start_period: 30s
    mode: "0644"

# Stop containers that will use gluetun's network to free up ports
# This ensures idempotent deployment when switching network modes
- name: Stop containers that use Gluetun network (to free ports)
  ansible.builtin.shell:
    cmd: docker stop {{ item }} && docker rm {{ item }}
  loop:
    - prowlarr
    - sabnzbd
    - qbittorrent
    - umlautadaptarr
  failed_when: false
  changed_when: false

- name: Start Gluetun stack
  ansible.builtin.command:
    cmd: docker compose up -d
    chdir: "{{ media_services_stacks_dir }}/gluetun"
  register: gluetun_start
  changed_when: "'Started' in gluetun_start.stderr or 'Created' in gluetun_start.stderr"

- name: Wait for Gluetun container to be running
  ansible.builtin.shell:
    cmd: |
      for i in $(seq 1 60); do
        STATUS=$(docker inspect -f '{{ '{{' }}.State.Status{{ '}}' }}' gluetun 2>/dev/null)
        if [ "$STATUS" = "running" ]; then
          # Additional wait for VPN to establish
          sleep 10
          exit 0
        fi
        sleep 2
      done
      exit 1
  changed_when: false

# When Gluetun is recreated, containers using network_mode: container:gluetun
# lose their network namespace reference and must be recreated (not just restarted)
- name: Recreate containers dependent on Gluetun network
  ansible.builtin.shell:
    cmd: docker compose up -d --force-recreate
    chdir: "{{ media_services_stacks_dir }}/{{ item }}"
  loop:
    - prowlarr
    - sabnzbd
    - qbittorrent
    - umlautadaptarr
  when: gluetun_start.changed
  register: recreate_result
  failed_when: false
  changed_when: "'Recreated' in recreate_result.stderr or 'Created' in recreate_result.stderr"
