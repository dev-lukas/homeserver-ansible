---
# Configure NFS mount for mediapool

- name: Create media mount directory
  ansible.builtin.file:
    path: "{{ media_services_nfs_mount }}"
    state: directory
    mode: "0755"

- name: Add NFS mount to fstab
  ansible.builtin.lineinfile:
    path: /etc/fstab
    regexp: "^{{ media_services_nfs_server }}:{{ media_services_nfs_export }}"
    line: "{{ media_services_nfs_server }}:{{ media_services_nfs_export }} {{ media_services_nfs_mount }} nfs4 defaults,_netdev,noatime 0 0"
    state: present

- name: Mount NFS share
  ansible.builtin.mount:
    path: "{{ media_services_nfs_mount }}"
    src: "{{ media_services_nfs_server }}:{{ media_services_nfs_export }}"
    fstype: nfs4
    opts: defaults,_netdev,noatime
    state: mounted

- name: Verify NFS mount
  ansible.builtin.command:
    cmd: "df -h {{ media_services_nfs_mount }}"
  register: nfs_mount_status
  changed_when: false

- name: Display NFS mount status
  ansible.builtin.debug:
    msg: "{{ nfs_mount_status.stdout_lines }}"

- name: Create media subdirectories
  ansible.builtin.file:
    path: "{{ media_services_nfs_mount }}/{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - downloads
    - tv
    - movies
