---
# Install AdGuard Home in the LXC container

- name: Check if AdGuard Home is already installed
  ansible.builtin.command:
    cmd: "pct exec {{ adguard_vmid }} -- test -f /opt/AdGuardHome/AdGuardHome"
  register: adguard_installed
  failed_when: false
  changed_when: false

- name: Download and install AdGuard Home
  ansible.builtin.command:
    cmd: |
      pct exec {{ adguard_vmid }} -- bash -c 'curl -s -S -L https://raw.githubusercontent.com/AdguardTeam/AdGuardHome/master/scripts/install.sh | sh -s -- -v'
  when: adguard_installed.rc != 0
  register: adguard_install

- name: Create adguard system user
  ansible.builtin.command:
    cmd: "pct exec {{ adguard_vmid }} -- adduser -D -H -s /sbin/nologin -g 'AdGuard Home' adguard"
  changed_when: false
  failed_when: false

- name: Set ownership of AdGuard Home directory
  ansible.builtin.command:
    cmd: "pct exec {{ adguard_vmid }} -- chown -R adguard:adguard /opt/AdGuardHome"
  changed_when: false

- name: Create work directory for AdGuard Home
  ansible.builtin.command:
    cmd: "pct exec {{ adguard_vmid }} -- mkdir -p /var/lib/adguardhome"
  changed_when: false

- name: Set ownership of work directory
  ansible.builtin.command:
    cmd: "pct exec {{ adguard_vmid }} -- chown -R adguard:adguard /var/lib/adguardhome"
  changed_when: false

- name: Install libcap and yq
  ansible.builtin.command:
    cmd: "pct exec {{ adguard_vmid }} -- apk add --no-cache libcap yq"
  changed_when: false

- name: Allow AdGuard to bind to privileged ports
  ansible.builtin.command:
    cmd: "pct exec {{ adguard_vmid }} -- setcap 'cap_net_bind_service=+eip' /opt/AdGuardHome/AdGuardHome"
  changed_when: false

# Create minimal seed config for first run (skips setup wizard if user is set)
- name: Check if AdGuard config exists
  ansible.builtin.command:
    cmd: "pct exec {{ adguard_vmid }} -- test -f /opt/AdGuardHome/AdGuardHome.yaml"
  register: adguard_config_exists
  failed_when: false
  changed_when: false

- name: Create minimal seed config for first run
  ansible.builtin.command:
    cmd: |
      pct exec {{ adguard_vmid }} -- sh -c 'cat > /opt/AdGuardHome/AdGuardHome.yaml << EOF
      http:
        address: 0.0.0.0:{{ adguard_web_port }}
      dns:
        bind_hosts:
          - 0.0.0.0
        port: {{ adguard_dns_port }}
      users:
        - name: {{ adguard_admin_user }}
          password: {{ adguard_admin_password_hash }}
      os:
        user: adguard
        group: adguard
      EOF'
  when: adguard_config_exists.rc != 0

- name: Set ownership of config file
  ansible.builtin.command:
    cmd: "pct exec {{ adguard_vmid }} -- chown adguard:adguard /opt/AdGuardHome/AdGuardHome.yaml"
  changed_when: false

# Patch existing config with yq (idempotent, works with any schema version)
- name: Patch AdGuard config - HTTP bind address
  ansible.builtin.command:
    cmd: "pct exec {{ adguard_vmid }} -- yq -i '.http.address = \"0.0.0.0:{{ adguard_web_port }}\"' /opt/AdGuardHome/AdGuardHome.yaml"
  changed_when: false

- name: Patch AdGuard config - DNS bind hosts
  ansible.builtin.command:
    cmd: "pct exec {{ adguard_vmid }} -- yq -i '.dns.bind_hosts = [\"0.0.0.0\"]' /opt/AdGuardHome/AdGuardHome.yaml"
  changed_when: false

- name: Patch AdGuard config - DNS port
  ansible.builtin.command:
    cmd: "pct exec {{ adguard_vmid }} -- yq -i '.dns.port = {{ adguard_dns_port }}' /opt/AdGuardHome/AdGuardHome.yaml"
  changed_when: false

- name: Patch AdGuard config - run as adguard user
  ansible.builtin.command:
    cmd: "pct exec {{ adguard_vmid }} -- yq -i '.os.user = \"adguard\" | .os.group = \"adguard\"' /opt/AdGuardHome/AdGuardHome.yaml"
  changed_when: false

- name: Create OpenRC init script for AdGuard Home
  ansible.builtin.command:
    cmd: |
      pct exec {{ adguard_vmid }} -- sh -c 'cat > /etc/init.d/adguardhome << EOF
      #!/sbin/openrc-run
      
      name="AdGuard Home"
      description="Network-wide ads & trackers blocking DNS server"
      command="/opt/AdGuardHome/AdGuardHome"
      command_args="-s run -w /var/lib/adguardhome"
      command_user="adguard:adguard"
      command_background="yes"
      pidfile="/run/\${RC_SVCNAME}.pid"
      start_stop_daemon_args="--stdout /var/log/adguardhome.log --stderr /var/log/adguardhome.log"
      
      depend() {
          need net
          after firewall
      }
      EOF'
  changed_when: false

- name: Make AdGuard Home init script executable
  ansible.builtin.command:
    cmd: "pct exec {{ adguard_vmid }} -- chmod +x /etc/init.d/adguardhome"
  changed_when: false

- name: Enable AdGuard Home service on boot
  ansible.builtin.command:
    cmd: "pct exec {{ adguard_vmid }} -- rc-update add adguardhome default"
  changed_when: false
  failed_when: false

- name: Restart AdGuard Home service to apply config
  ansible.builtin.command:
    cmd: "pct exec {{ adguard_vmid }} -- rc-service adguardhome restart"
  changed_when: false
  failed_when: false

- name: Display AdGuard Home access info
  ansible.builtin.debug:
    msg: |
      AdGuard Home installed successfully!
      
      Access the web interface at: http://{{ adguard_ip }}:{{ adguard_web_port }}
      
      Login with: {{ adguard_admin_user }}
      
      Set your devices/router DNS to: {{ adguard_ip }}
