---
# Install AdGuard Home in the LXC container

- name: Check if AdGuard Home is already installed
  ansible.builtin.command:
    cmd: "pct exec {{ adguard_vmid }} -- test -f /opt/AdGuardHome/AdGuardHome"
  register: adguard_installed
  failed_when: false
  changed_when: false

- name: Download and install AdGuard Home
  ansible.builtin.command:
    cmd: |
      pct exec {{ adguard_vmid }} -- bash -c 'curl -s -S -L https://raw.githubusercontent.com/AdguardTeam/AdGuardHome/master/scripts/install.sh | sh -s -- -v'
  when: adguard_installed.rc != 0
  register: adguard_install

- name: Create work directory for AdGuard Home
  ansible.builtin.command:
    cmd: "pct exec {{ adguard_vmid }} -- mkdir -p /var/lib/adguardhome"
  changed_when: false

- name: Install yq for config patching
  ansible.builtin.command:
    cmd: "pct exec {{ adguard_vmid }} -- apk add --no-cache yq"
  changed_when: false

# Create minimal seed config for first run (skips setup wizard if user is set)
- name: Check if AdGuard config exists
  ansible.builtin.command:
    cmd: "pct exec {{ adguard_vmid }} -- test -f /opt/AdGuardHome/AdGuardHome.yaml"
  register: adguard_config_exists
  failed_when: false
  changed_when: false

- name: Create minimal seed config for first run
  ansible.builtin.command:
    cmd: |
      pct exec {{ adguard_vmid }} -- sh -c 'cat > /opt/AdGuardHome/AdGuardHome.yaml << "EOF"
      http:
        address: 0.0.0.0:{{ adguard_web_port }}
      dns:
        bind_hosts:
          - 0.0.0.0
        port: {{ adguard_dns_port }}
      users:
        - name: {{ adguard_admin_user }}
          password: "{{ adguard_admin_password_hash }}"
      EOF'
  when: adguard_config_exists.rc != 0

# Patch existing config with yq (idempotent, works with any schema version)
- name: Patch AdGuard config - HTTP bind address
  ansible.builtin.command:
    cmd: "pct exec {{ adguard_vmid }} -- yq -i '.http.address = \"0.0.0.0:{{ adguard_web_port }}\"' /opt/AdGuardHome/AdGuardHome.yaml"
  changed_when: false

- name: Patch AdGuard config - DNS bind hosts
  ansible.builtin.command:
    cmd: "pct exec {{ adguard_vmid }} -- yq -i '.dns.bind_hosts = [\"0.0.0.0\"]' /opt/AdGuardHome/AdGuardHome.yaml"
  changed_when: false

- name: Patch AdGuard config - DNS port
  ansible.builtin.command:
    cmd: "pct exec {{ adguard_vmid }} -- yq -i '.dns.port = {{ adguard_dns_port }}' /opt/AdGuardHome/AdGuardHome.yaml"
  changed_when: false

- name: Remove os.user/group from config to run as root
  ansible.builtin.command:
    cmd: "pct exec {{ adguard_vmid }} -- yq -i 'del(.os)' /opt/AdGuardHome/AdGuardHome.yaml"
  changed_when: false

- name: Enable AdGuard Home service on boot
  ansible.builtin.command:
    cmd: "pct exec {{ adguard_vmid }} -- rc-update add AdGuardHome default"
  changed_when: false
  failed_when: false

- name: Restart AdGuard Home service to apply config
  ansible.builtin.command:
    cmd: "pct exec {{ adguard_vmid }} -- rc-service AdGuardHome restart"
  changed_when: false
  failed_when: false

- name: Wait for AdGuard Home to start
  ansible.builtin.pause:
    seconds: 5

- name: Verify AdGuard Home is running
  ansible.builtin.command:
    cmd: "pct exec {{ adguard_vmid }} -- rc-service AdGuardHome status"
  register: adguard_status
  changed_when: false
  failed_when: "'started' not in adguard_status.stdout"

# Configure upstream DNS servers (Quad9 + Mullvad with parallel requests, ControlD as fallback)
- name: Configure upstream DNS servers
  ansible.builtin.command:
    cmd: |
      pct exec {{ adguard_vmid }} -- sh -c 'curl -s -u "{{ adguard_admin_user }}:{{ adguard_admin_password }}" \
        -X POST "http://127.0.0.1:{{ adguard_web_port }}/control/dns_config" \
        -H "Content-Type: application/json" \
        -d "{
          \"upstream_dns\": [
            \"https://dns.quad9.net/dns-query\",
            \"https://dns.mullvad.net/dns-query\",
            \"tls://dns.quad9.net\",
            \"tls://dns.mullvad.net\"
          ],
          \"fallback_dns\": [
            \"https://freedns.controld.com/p0\",
            \"tls://freedns.controld.com\"
          ],
          \"upstream_mode\": \"parallel\",
          \"ratelimit\": 0,
          \"blocking_mode\": \"default\",
          \"edns_cs_enabled\": true,
          \"dnssec_enabled\": true
        }"'
  changed_when: false

# Add Hagezi blocklists from AdGuard's official filter options
- name: Add Hagezi Pro blocklist
  ansible.builtin.command:
    cmd: |
      pct exec {{ adguard_vmid }} -- sh -c 'curl -s -u "{{ adguard_admin_user }}:{{ adguard_admin_password }}" \
        -X POST "http://127.0.0.1:{{ adguard_web_port }}/control/filtering/add_url" \
        -H "Content-Type: application/json" \
        -d "{
          \"name\": \"HaGeZi Pro\",
          \"url\": \"https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/pro.txt\",
          \"enabled\": true
        }"'
  changed_when: false
  failed_when: false

- name: Add Hagezi Xiaomi Tracker blocklist
  ansible.builtin.command:
    cmd: |
      pct exec {{ adguard_vmid }} -- sh -c 'curl -s -u "{{ adguard_admin_user }}:{{ adguard_admin_password }}" \
        -X POST "http://127.0.0.1:{{ adguard_web_port }}/control/filtering/add_url" \
        -H "Content-Type: application/json" \
        -d "{
          \"name\": \"HaGeZi Xiaomi Tracker\",
          \"url\": \"https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/native.xiaomi.txt\",
          \"enabled\": true
        }"'
  changed_when: false
  failed_when: false

- name: Add Hagezi Windows Tracker blocklist
  ansible.builtin.command:
    cmd: |
      pct exec {{ adguard_vmid }} -- sh -c 'curl -s -u "{{ adguard_admin_user }}:{{ adguard_admin_password }}" \
        -X POST "http://127.0.0.1:{{ adguard_web_port }}/control/filtering/add_url" \
        -H "Content-Type: application/json" \
        -d "{
          \"name\": \"HaGeZi Windows Tracker\",
          \"url\": \"https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/native.winoffice.txt\",
          \"enabled\": true
        }"'
  changed_when: false
  failed_when: false

- name: Add Hagezi Apple Tracker blocklist
  ansible.builtin.command:
    cmd: |
      pct exec {{ adguard_vmid }} -- sh -c 'curl -s -u "{{ adguard_admin_user }}:{{ adguard_admin_password }}" \
        -X POST "http://127.0.0.1:{{ adguard_web_port }}/control/filtering/add_url" \
        -H "Content-Type: application/json" \
        -d "{
          \"name\": \"HaGeZi Apple Tracker\",
          \"url\": \"https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/native.apple.txt\",
          \"enabled\": true
        }"'
  changed_when: false
  failed_when: false

- name: Refresh blocklist filters
  ansible.builtin.command:
    cmd: |
      pct exec {{ adguard_vmid }} -- sh -c 'curl -s -u "{{ adguard_admin_user }}:{{ adguard_admin_password }}" \
        -X POST "http://127.0.0.1:{{ adguard_web_port }}/control/filtering/refresh" \
        -H "Content-Type: application/json" \
        -d "{\"whitelist\": false}"'
  changed_when: false

- name: Display AdGuard Home access info
  ansible.builtin.debug:
    msg: |
      AdGuard Home installed and configured successfully!
      
      Access the web interface at: http://{{ adguard_ip }}:{{ adguard_web_port }}
      
      Login with: {{ adguard_admin_user }}
      
      Set your devices/router DNS to: {{ adguard_ip }}
      
      Configured:
        - Upstream DNS: Quad9 + Mullvad (parallel mode)
        - Fallback DNS: ControlD
        - DNSSEC: Enabled
        - Blocklists: HaGeZi Pro, Xiaomi, Windows, Apple Trackers
