---
# Homepage - Modern self-hosted dashboard

- name: Create Homepage stack directories
  ansible.builtin.file:
    path: "{{ local_services_stacks_dir }}/homepage/config"
    state: directory
    mode: "0755"

- name: Create Homepage images directory
  ansible.builtin.file:
    path: "{{ local_services_stacks_dir }}/homepage/images"
    state: directory
    mode: "0755"

- name: Download background image
  ansible.builtin.get_url:
    url: "{{ homepage_background_url }}"
    dest: "{{ local_services_stacks_dir }}/homepage/images/background.jpg"
    mode: "0644"
  when: homepage_background_url | length > 0

- name: Deploy Homepage docker-compose.yml
  ansible.builtin.copy:
    dest: "{{ local_services_stacks_dir }}/homepage/docker-compose.yml"
    content: |
      services:
        homepage:
          image: ghcr.io/gethomepage/homepage:latest
          container_name: homepage
          restart: unless-stopped
          ports:
            - "{{ local_services_homepage_port }}:3000"
          volumes:
            - ./config:/app/config
            - ./images:/app/public/images
          environment:
            - TZ=Europe/Berlin
            - HOMEPAGE_ALLOWED_HOSTS=home.{{ reverse_proxy_domain }}
    mode: "0644"

- name: Deploy Homepage settings.yaml
  ansible.builtin.copy:
    dest: "{{ local_services_stacks_dir }}/homepage/config/settings.yaml"
    content: |
      title: Homeserver
      favicon: https://cdn.jsdelivr.net/gh/walkxcode/dashboard-icons/png/homepage.png
      theme: dark
      color: slate
      headerStyle: clean
      {% if homepage_background_url | length > 0 %}
      background:
        image: /images/background.jpg
        blur: sm
        opacity: 30
      {% endif %}
      layout:
        - System Metrics:
            style: row
            columns: 4
        - Storage:
            style: row
            columns: {{ homepage_storage_mounts | length }}
        - Local Services:
            style: row
            columns: 3
        - Infrastructure:
            style: row
            columns: 3
    mode: "0644"

- name: Deploy Homepage services.yaml
  ansible.builtin.copy:
    dest: "{{ local_services_stacks_dir }}/homepage/config/services.yaml"
    content: |
      - System Metrics:
          - CPU:
              widget:
                type: glances
                url: http://{{ homepage_proxmox_ip }}:{{ glances_port }}
                version: 4
                metric: cpu
          - Memory:
              widget:
                type: glances
                url: http://{{ homepage_proxmox_ip }}:{{ glances_port }}
                version: 4
                metric: memory
          - Disk I/O:
              widget:
                type: glances
                url: http://{{ homepage_proxmox_ip }}:{{ glances_port }}
                version: 4
                metric: disk:sda
          - CPU Temperature:
              widget:
                type: glances
                url: http://{{ homepage_proxmox_ip }}:{{ glances_port }}
                version: 4
                metric: sensor:Package id 0

      - Storage:
      {% for storage in homepage_storage_mounts %}
          - {{ storage.name }}:
              widget:
                type: glances
                url: http://{{ homepage_proxmox_ip }}:{{ glances_port }}
                version: 4
                metric: "fs:{{ storage.mount }}"
      {% endfor %}

      - Local Services:
          - BentoPDF:
              icon: mdi-file-pdf-box
              href: https://pdf.{{ reverse_proxy_domain }}
              description: Privacy-first PDF toolkit
          - VERT:
              icon: mdi-file-swap
              href: https://vert.{{ reverse_proxy_domain }}
              description: File converter
          - Mealie:
              icon: mdi-silverware-fork-knife
              href: https://recipes.{{ reverse_proxy_domain }}
              description: Recipe manager

      - Infrastructure:
          - Home Assistant:
              icon: mdi-home-assistant
              href: https://ha.{{ reverse_proxy_domain }}
              description: Home automation
          - AdGuard Home:
              icon: mdi-shield-check
              href: https://adguard.{{ reverse_proxy_domain }}
              description: DNS & ad blocking
          - Proxmox:
              icon: mdi-server
              href: https://proxmox.{{ reverse_proxy_domain }}
              description: Virtualization platform
    mode: "0644"

- name: Deploy Homepage bookmarks.yaml
  ansible.builtin.copy:
    dest: "{{ local_services_stacks_dir }}/homepage/config/bookmarks.yaml"
    content: |
      - Developer:
        - Github:
            - abbr: GH
              href: https://github.com/dev-lukas/
    mode: "0644"

- name: Deploy Homepage widgets.yaml
  ansible.builtin.copy:
    dest: "{{ local_services_stacks_dir }}/homepage/config/widgets.yaml"
    content: |
      - datetime:
          text_size: xl
          format:
            dateStyle: long
            timeStyle: short
      - glances:
          url: http://{{ homepage_proxmox_ip }}:{{ glances_port }}
          version: 4
          metric: info
          chart: false
    mode: "0644"

- name: Start Homepage stack
  ansible.builtin.command:
    cmd: docker compose up -d
    chdir: "{{ local_services_stacks_dir }}/homepage"
  register: homepage_start
  changed_when: "'Started' in homepage_start.stderr or 'Created' in homepage_start.stderr"
