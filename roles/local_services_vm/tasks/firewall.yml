---
# Install and configure UFW firewall

- name: Install UFW
  ansible.builtin.apt:
    name: ufw
    state: present

- name: Set UFW default incoming policy to deny
  community.general.ufw:
    direction: incoming
    default: "{{ local_services_ufw_default_incoming }}"

- name: Set UFW default outgoing policy to allow
  community.general.ufw:
    direction: outgoing
    default: "{{ local_services_ufw_default_outgoing }}"

- name: Allow SSH through UFW
  community.general.ufw:
    rule: allow
    port: "{{ local_services_ssh_port }}"
    proto: tcp
    comment: "SSH"

- name: Allow BentoPDF port through UFW
  community.general.ufw:
    rule: allow
    port: "{{ local_services_bentopdf_port }}"
    proto: tcp
    comment: "BentoPDF"

- name: Allow VERT port through UFW
  community.general.ufw:
    rule: allow
    port: "{{ local_services_vert_port }}"
    proto: tcp
    comment: "VERT File Converter"

- name: Allow Mealie port through UFW
  community.general.ufw:
    rule: allow
    port: "{{ local_services_mealie_port }}"
    proto: tcp
    comment: "Mealie Recipes"

- name: Allow Homepage port through UFW
  community.general.ufw:
    rule: allow
    port: "{{ local_services_homepage_port }}"
    proto: tcp
    comment: "Homepage Dashboard"

- name: Enable UFW
  community.general.ufw:
    state: enabled

- name: Check UFW status
  ansible.builtin.command:
    cmd: ufw status verbose
  register: ufw_status
  changed_when: false

- name: Display UFW status
  ansible.builtin.debug:
    msg: "{{ ufw_status.stdout_lines }}"
