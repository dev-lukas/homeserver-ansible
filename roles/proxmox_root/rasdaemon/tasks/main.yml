---
# Rasdaemon - ECC memory error monitoring

- name: Install rasdaemon
  ansible.builtin.apt:
    name: rasdaemon
    state: present
    update_cache: true

- name: Ensure rasdaemon runs with --record flag
  ansible.builtin.lineinfile:
    path: /etc/default/rasdaemon
    regexp: "^RASDAEMON_ARGS="
    line: 'RASDAEMON_ARGS="--record"'
    create: true
    mode: "0644"
  notify: Restart rasdaemon

- name: Ensure DIMM labels directory exists
  ansible.builtin.file:
    path: /etc/ras/dimm_labels.d
    state: directory
    mode: "0755"

- name: Deploy DIMM labels for Asus Pro WS W680-ACE
  ansible.builtin.copy:
    dest: /etc/ras/dimm_labels.d/asus_w680_ace
    content: |
      Vendor: ASUSTeK COMPUTER INC.
      Model: Pro WS W680-ACE
         DIMM_A1: 0.0.0, 0.1.0
         DIMM_A2: 0.0.1, 0.1.1
         DIMM_B1: 1.0.0, 1.1.0
         DIMM_B2: 1.0.1, 1.1.1
    mode: "0644"
  register: dimm_labels

- name: Enable and start rasdaemon service
  ansible.builtin.systemd:
    name: rasdaemon
    enabled: true
    state: started
    daemon_reload: true

- name: Wait for rasdaemon to initialize database
  ansible.builtin.pause:
    seconds: 3

- name: Register DIMM labels
  ansible.builtin.command:
    cmd: ras-mc-ctl --register-labels
  when: dimm_labels.changed
  changed_when: true

- name: Enable and start ras-mc-ctl service
  ansible.builtin.systemd:
    name: ras-mc-ctl
    enabled: true
    state: started
  failed_when: false

- name: Check EDAC driver status
  ansible.builtin.command:
    cmd: ras-mc-ctl --status
  register: ras_status
  changed_when: false
  failed_when: false

- name: Display EDAC/rasdaemon status
  ansible.builtin.debug:
    msg: "{{ ras_status.stdout_lines }}"

# ECC Stats for Homepage Dashboard
- name: Check if local-services VM is reachable
  ansible.builtin.wait_for:
    host: "{{ local_services_ip }}"
    port: 22
    timeout: 5
  register: vm_reachable
  failed_when: false

- name: Get Proxmox root public key
  ansible.builtin.slurp:
    src: /root/.ssh/id_rsa.pub
  register: proxmox_root_pubkey
  when: vm_reachable.state is defined and vm_reachable.state == "started"

- name: Add local-services VM to in-memory inventory for SSH key setup
  ansible.builtin.add_host:
    name: "local-services-ecc"
    ansible_host: "{{ local_services_ip }}"
    ansible_user: root
    ansible_ssh_private_key_file: /tmp/.ansible_deploy_key
    ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
  when: vm_reachable.state is defined and vm_reachable.state == "started"

- name: Add Proxmox root SSH key to local-services VM
  ansible.posix.authorized_key:
    user: root
    state: present
    key: "{{ proxmox_root_pubkey.content | b64decode | trim }}"
    comment: "Proxmox ECC stats"
  delegate_to: "local-services-ecc"
  when: vm_reachable.state is defined and vm_reachable.state == "started"

- name: Create API directory on local-services VM
  ansible.builtin.file:
    path: /opt/stacks/homepage/api
    state: directory
    mode: "0755"
  delegate_to: "local-services-ecc"
  when: vm_reachable.state is defined and vm_reachable.state == "started"

- name: Deploy ECC stats script
  ansible.builtin.copy:
    src: ecc-stats.sh
    dest: /usr/local/bin/ecc-stats.sh
    mode: "0755"

- name: Create cron job for ECC stats
  ansible.builtin.cron:
    name: "Update ECC stats for Homepage"
    minute: "*/5"
    job: "/usr/local/bin/ecc-stats.sh {{ local_services_ip }} /opt/stacks/homepage/api/ecc.json > /dev/null 2>&1"
  when: vm_reachable.state is defined and vm_reachable.state == "started"

- name: Run ECC stats script once to create initial JSON
  ansible.builtin.command:
    cmd: /usr/local/bin/ecc-stats.sh {{ local_services_ip }} /opt/stacks/homepage/api/ecc.json
  when: vm_reachable.state is defined and vm_reachable.state == "started"
  changed_when: true

