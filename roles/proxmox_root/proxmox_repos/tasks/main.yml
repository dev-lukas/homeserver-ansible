---
# Proxmox repository configuration
# Disables enterprise repos and enables no-subscription repos

- name: Remove Proxmox enterprise repository files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/apt/sources.list.d/pve-enterprise.list
    - /etc/apt/sources.list.d/pve-enterprise.sources
    - /etc/apt/sources.list.d/ceph.list
    - /etc/apt/sources.list.d/ceph.sources
  register: enterprise_repos_removed

- name: Add Proxmox no-subscription repository
  ansible.builtin.apt_repository:
    repo: "deb http://download.proxmox.com/debian/pve {{ ansible_facts['distribution_release'] }} pve-no-subscription"
    filename: pve-no-subscription
    state: present
    update_cache: false
  register: nosub_repo_added

- name: Update apt cache after repo changes
  ansible.builtin.apt:
    update_cache: true
  when: enterprise_repos_removed.changed or nosub_repo_added.changed

- name: Include cluster services disable tasks
  ansible.builtin.include_tasks: disable_cluster.yml
  when: proxmox_disable_cluster | default(true)
  tags:
    - cluster
